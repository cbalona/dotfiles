---
- hosts: localhost
  connection: local
  become: true # Run as root for packages
  vars:
    user_home: "{{ lookup('env', 'HOME') }}"
    username: "{{ lookup('env', 'USER') }}"

  tasks:
    # System Packages
    - name: Update Apt Cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Essential Tools
      apt:
        name:
          - bat
          - build-essential
          - curl
          - eza
          - fzf
          - git
          - htop
          - nala
          - neovim
          - ripgrep
          - unzip
          - wget
          - zsh
          - zsh-autosuggestions
          - zsh-syntax-highlighting
        state: present
        update-cache: yes

    - name: Install Bitwarden CLI
      unarchive:
        src: "https://vault.bitwarden.com/download/?app=cli&platform=linux"
        dest: "/usr/local/bin"
        remote_src: yes
        mode: '0755'
        # The zip contains a single binary named 'bw'. 
        # Validating existence prevents re-downloading.
        creates: "/usr/local/bin/bw" 
      become: true

    # Install 'uv'
    - name: Install uv
      shell: curl -LsSf https://astral.sh/uv/install.sh | sh
      args:
        creates: "{{ user_home }}/.cargo/bin/uv"
      become: false

    # Install Starship
    - name: Install Starship
      shell: curl -sS https://starship.rs/install.sh | sh -s -- -y
      args:
        creates: /usr/local/bin/starship

    # Dotfiles Linking
    - name: Configure WSL Specific Git Settings
      copy:
        dest: "{{ user_home }}/.gitconfig.wsl"
        content: |
          [credential]
              helper = /mnt/c/Program\\ Files/Git/mingw64/bin/git-credential-manager.exe
          [core]
              filemode = true

    - name: Ensure .config Directory Exists
      file:
        path: "{{ user_home }}/.config"
        state: directory
        mode: '0755'
        owner: "{{ username }}"
        group: "{{ username }}"
      become: false
      
    - name: Link Configs
      file:
        src: "{{ playbook_dir }}/../configs/{{ item.src }}"
        dest: "{{ user_home }}/{{ item.dest }}"
        state: link
        force: yes
      loop:
        - { src: 'zshrc', dest: '.zshrc' }
        - { src: 'gitconfig', dest: '.gitconfig' }
        - { src: 'starship.toml', dest: '.config/starship.toml' }
      become: false
      
    # Shell Change
    - name: Ensure User Shell is Zsh
      user:
        name: "{{ username }}"
        shell: /bin/zsh

    - name: Configure Local Git Settings (WSL)
      copy:
        dest: "{{ user_home }}/.gitconfig.local"
        mode: '0644'
        content: |
          [credential]
              helper = "/mnt/c/Program\\ Files/Git/mingw64/bin/git-credential-manager.exe"
          [core]
              sshCommand = "ssh.exe"

    - name: Install Rust
      shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      args:
        creates: "{{ user_home }}/.cargo/bin/rustc"
      become: false

    # Loop your cargo installs to reduce code duplication
    - name: Install Cargo Crates
      community.general.cargo:
        name: "{{ item }}"
        state: present
      loop:
        - code2prompt
        - zoxide
      environment:
        PATH: "{{ user_home }}/.cargo/bin:{{ ansible_env.PATH }}"
      become: false